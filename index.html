<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOFTCON-MYS | Dashboard</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#002344">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
    /* Men칰 r치pido: texto m치s peque침o y efecto hover din치mico */
    .menu-rapido-btn span {
        font-size: 9px;
        transition: font-size 0.2s, transform 0.2s;
    }
    .menu-rapido-btn {
        transition: transform 0.2s;
    }
    .menu-rapido-btn:hover,
    .menu-rapido-btn:focus {
        transform: scale(1.08);
    }
    .menu-rapido-btn:hover span,
    .menu-rapido-btn:focus span {
        font-size: 12px;
        font-weight: bold;
    }
    </style>
</head>
<body class="bg-slate-100 font-sans">

    <nav class="bg-[#002344] text-white p-4 flex justify-between items-center shadow-xl sticky top-0 z-50">
        <div>
            <h1 class="text-xl font-black tracking-tighter">SOFTCON-MYS</h1>
            <p class="text-[10px] text-yellow-500 font-bold">CONSTRUYENDO TU FUTURO</p>
        </div>
        <div class="flex items-center gap-4">
            <button id="installBtn" class="hidden bg-yellow-600 text-xs px-3 py-1 rounded-full font-bold">Instalar App</button>
            <button onclick="cerrarSesion()" class="flex items-center gap-2 bg-red-500 hover:bg-red-700 px-4 py-2 rounded-xl text-sm font-bold transition">
                <i data-lucide="log-out" class="w-4 h-4"></i> Salir
            </button>
        </div>
    </nav>

    <main class="p-4 max-w-7xl mx-auto">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <!-- Men칰 de Accesos R치pidos -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3 mb-8">
                        <button onclick="window.location.href='proyectos.html'" class="menu-rapido-btn flex flex-col items-center justify-center bg-white p-4 rounded-3xl shadow-sm border-b-4 border-green-600 hover:bg-green-50 transition">
                            <i data-lucide="layout" class="text-green-600 mb-2 transition"></i>
                            <span class="font-black text-slate-700 uppercase">Proyectos</span>
                        </button>
                        <button onclick="window.location.href='apu.html'" class="menu-rapido-btn flex flex-col items-center justify-center bg-white p-4 rounded-3xl shadow-sm border-b-4 border-cyan-600 hover:bg-cyan-50 transition">
                            <i data-lucide="calculator" class="text-cyan-600 mb-2 transition"></i>
                            <span class="font-black text-slate-700 uppercase">APU / C치lculo</span>
                        </button>
                        <button onclick="window.location.href='asistencia.html'" class="menu-rapido-btn flex flex-col items-center justify-center bg-white p-4 rounded-3xl shadow-sm border-b-4 border-blue-600 hover:bg-blue-50 transition">
                            <i data-lucide="map-pin" class="text-blue-600 mb-2 transition"></i>
                            <span class="font-black text-slate-700 uppercase">RRHH / GPS</span>
                        </button>
                        <button onclick="window.location.href='compras.html'" class="menu-rapido-btn flex flex-col items-center justify-center bg-white p-4 rounded-3xl shadow-sm border-b-4 border-yellow-500 hover:bg-yellow-50 transition">
                            <i data-lucide="shopping-cart" class="text-yellow-600 mb-2 transition"></i>
                            <span class="font-black text-slate-700 uppercase">Compras</span>
                        </button>
                        <button onclick="window.location.href='hhrr.html'" class="menu-rapido-btn flex flex-col items-center justify-center bg-white p-4 rounded-3xl shadow-sm border-b-4 border-purple-600 hover:bg-purple-50 transition">
                            <i data-lucide="file-signature" class="text-purple-600 mb-2 transition"></i>
                            <span class="font-black text-slate-700 uppercase">Contratos</span>
                        </button>
                        <button onclick="window.location.href='finanzas.html'" class="menu-rapido-btn flex flex-col items-center justify-center bg-white p-4 rounded-3xl shadow-sm border-b-4 border-emerald-600 hover:bg-emerald-50 transition">
                            <i data-lucide="wallet" class="text-emerald-600 mb-2 transition"></i>
                            <span class="font-black text-slate-700 uppercase">Finanzas</span>
                        </button>
                        <button onclick="window.location.href='bodega.html'" class="menu-rapido-btn flex flex-col items-center justify-center bg-white p-4 rounded-3xl shadow-sm border-b-4 border-orange-600 hover:bg-orange-50 transition">
                            <i data-lucide="package" class="text-orange-600 mb-2 transition"></i>
                            <span class="font-black text-slate-700 uppercase">Bodega</span>
                        </button>
                        <button onclick="window.print()" class="menu-rapido-btn flex flex-col items-center justify-center bg-white p-4 rounded-3xl shadow-sm border-b-4 border-slate-800 hover:bg-slate-50 transition">
                            <i data-lucide="printer" class="text-slate-800 mb-2 transition"></i>
                            <span class="font-black text-slate-700 uppercase">Reportes</span>
                        </button>
                    </div>
            <div class="bg-white p-4 rounded-3xl shadow-sm border-b-4 border-blue-500 text-center">
                <p class="text-xs text-slate-500 uppercase font-bold">Proyectos Activos</p>
                <h2 id="kpi-activos" class="text-2xl font-black text-[#002344]">0</h2>
            </div>
            <div class="bg-white p-4 rounded-3xl shadow-sm border-b-4 border-yellow-500 text-center">
                <p class="text-xs text-slate-500 uppercase font-bold">D칤as Retraso Prom.</p>
                <h2 id="kpi-retraso" class="text-2xl font-black text-red-600">0</h2>
            </div>
            <div class="bg-white p-4 rounded-3xl shadow-sm border-b-4 border-green-500 text-center">
                <p class="text-xs text-slate-500 uppercase font-bold">Contratos Firmados</p>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                    <div id="progreso-contratos" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-3xl shadow-sm border-b-4 border-purple-500 text-center">
                <p class="text-xs text-slate-500 uppercase font-bold">Variaci칩n Precios</p>
                <h2 id="kpi-ia-status" class="text-lg font-black text-green-600">칍PTIMO</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-[2rem] shadow-md">
                <h3 class="text-sm font-black text-[#002344] mb-4">PRESUPUESTO: REAL VS PROG.</h3>
                <canvas id="chartPresupuesto"></canvas>
            </div>
            <div class="bg-white p-6 rounded-[2rem] shadow-md text-center">
                <h3 class="text-sm font-black text-[#002344] mb-4">MARGEN DE UTILIDAD</h3>
                <canvas id="chartMargen"></canvas>
            </div>
            <div class="bg-white p-6 rounded-[2rem] shadow-md">
                <h3 class="text-sm font-black text-[#002344] mb-4">TOP GASTO MATERIALES</h3>
                <canvas id="chartPareto"></canvas>
            </div>
            <div class="bg-white p-6 rounded-[2rem] shadow-md">
                <h3 class="text-sm font-black text-[#002344] mb-4">FLUJO DE CAJA MENSUAL</h3>
                <canvas id="chartFlujo"></canvas>
            </div>
            <div class="bg-white p-6 rounded-[2rem] shadow-md">
                <h3 class="text-sm font-black text-[#002344] mb-4">AVANCE F칈SICO (CURVA S)</h3>
                <canvas id="chartCurvaS"></canvas>
            </div>
            <div class="bg-white p-6 rounded-[2rem] shadow-md">
                <h3 class="text-sm font-black text-[#002344] mb-4">DISTRIBUCI칍N LABORAL</h3>
                <canvas id="chartRRHH"></canvas>
            </div>
            <div class="bg-white p-6 rounded-[2rem] shadow-md lg:col-span-2">
                <h3 class="text-sm font-black text-[#002344] mb-4 flex items-center gap-2">
                    <i data-lucide="map-pin" class="text-red-500"></i> UBICACI칍N DE EQUIPO EN TIEMPO REAL
                </h3>
                <div id="map" class="w-full h-[400px] rounded-2xl border-2 border-slate-100 shadow-inner"></div>
            </div>
        </div>
    </main>

    <!-- Scripts principales -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDa56pchnXE5FVOSXlfwEGUuFkcOWnH25A&callback=initMap" async defer></script>
    <script>
    // --- URL_DATABASE para backend ---
    const URL_DATABASE = "https://script.google.com/macros/s/AKfycbxACLXsnOalHL6GE9I0x3JrbXZ8lzrnRBi8RPW-tTjhTPKzFoYzjoGnBQoO0OiSX7L57g/exec";

    // --- L칍GICA DE CIERRE DE SESI칍N ---
    function cerrarSesion() {
        localStorage.removeItem("usuario_softcon");
        localStorage.removeItem("rol_softcon");
        localStorage.removeItem("usuario_nombre");
        window.location.href = "login.html";
    }

    // --- INICIALIZACI칍N DE GR츼FICAS ---
    function initCharts() {
        Chart.defaults.font.family = 'sans-serif';
        Chart.defaults.color = '#64748b';
        new Chart(document.getElementById('chartPresupuesto'), {
            type: 'bar',
            data: {
                labels: ['Obra A', 'Obra B', 'Obra C'],
                datasets: [
                    { label: 'Programado', data: [50000, 80000, 45000], backgroundColor: '#cbd5e1' },
                    { label: 'Real', data: [55000, 72000, 48000], backgroundColor: '#002344' }
                ]
            }
        });
        new Chart(document.getElementById('chartMargen'), {
            type: 'doughnut',
            data: {
                labels: ['Costos', 'Utilidad'],
                datasets: [{ data: [75, 25], backgroundColor: ['#f1f5f9', '#e1ad01'] }]
            },
            options: { cutout: '70%' }
        });
        new Chart(document.getElementById('chartFlujo'), {
            type: 'line',
            data: {
                labels: ['Ene', 'Feb', 'Mar'],
                datasets: [
                    { label: 'Entradas', data: [100, 150, 130], borderColor: '#22c55e', fill: true, backgroundColor: 'rgba(34, 197, 94, 0.1)' },
                    { label: 'Salidas', data: [80, 120, 110], borderColor: '#ef4444', fill: true, backgroundColor: 'rgba(239, 68, 68, 0.1)' }
                ]
            }
        });
        new Chart(document.getElementById('chartCurvaS'), {
            type: 'line',
            data: {
                labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                datasets: [
                    { label: 'Te칩rico', data: [10, 30, 60, 100], borderColor: '#94a3b8', borderDash: [5, 5] },
                    { label: 'Real', data: [8, 25, 55, 90], borderColor: '#002344', tension: 0.4 }
                ]
            }
        });
        new Chart(document.getElementById('chartPareto'), {
            type: 'bar',
            indexAxis: 'y',
            data: {
                labels: ['Cemento', 'Acero', 'Arena', 'Madera', 'Pintura'],
                datasets: [{ label: 'Inversi칩n Q', data: [25000, 18000, 12000, 8000, 5000], backgroundColor: '#002344' }]
            }
        });
        new Chart(document.getElementById('chartRRHH'), {
            type: 'pie',
            data: {
                labels: ['Alba침il', 'Ayudante', 'Maestro'],
                datasets: [{ data: [15, 25, 5], backgroundColor: ['#002344', '#e1ad01', '#64748b'] }]
            }
        });
    }

    // --- INICIALIZACI칍N DEL MAPA Y DATOS DE ASISTENCIA ---
    function initMap() {
        const centro = { lat: 14.293, lng: -89.913 };
        const mapa = new google.maps.Map(document.getElementById("map"), {
            zoom: 15,
            center: centro
        });
        fetch(URL_DATABASE + "?pesta침a=REGISTRO_ASISTENCIA")
            .then(res => res.json())
            .then(data => {
                const encabezado = data[0];
                const idxNombre = encabezado.indexOf("nombre");
                const idxCoordenadas = encabezado.indexOf("coordenadas");
                const idxValidacion = encabezado.indexOf("validacion");
                const datosTrabajadores = data.slice(1).map(fila => ({
                    nombre: fila[idxNombre] || "Sin nombre",
                    coordenadas: fila[idxCoordenadas] || "0,0",
                    validacion: fila[idxValidacion] || "FUERA"
                })).filter(t => t.coordenadas !== "0,0");
                renderizarMapa(mapa, datosTrabajadores);
            })
            .catch(() => {
                new google.maps.Marker({
                    position: centro,
                    map: mapa,
                    title: "No se pudo cargar asistencia",
                    icon: "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"
                });
            });
    }
    function renderizarMapa(mapa, datosTrabajadores) {
        datosTrabajadores.forEach(t => {
            const [lat, lng] = t.coordenadas.split(',').map(Number);
            const colorIcono = (t.validacion === "FUERA") 
                ? "http://maps.google.com/mapfiles/ms/icons/red-dot.png" 
                : "http://maps.google.com/mapfiles/ms/icons/green-dot.png";
            new google.maps.Marker({
                position: { lat, lng },
                map: mapa,
                title: `${t.nombre} - ${t.validacion}`,
                icon: colorIcono
            });
        });
    }

    window.onload = () => {
        initCharts();
        if (window.google && window.google.maps) {
            initMap();
        }
        lucide.createIcons(); // Asegura que los iconos se vean siempre
    };

    // --- Service Worker y bot칩n de instalaci칩n ---
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker registrado correctamente'))
            .catch(err => console.log('Error al registrar SW', err));
    }
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const installBtn = document.getElementById('installBtn');
        if(installBtn) installBtn.classList.remove('hidden');
    });
    document.getElementById('installBtn')?.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                document.getElementById('installBtn').classList.add('hidden');
            }
            deferredPrompt = null;
        }
    });
    // --- FIN SCRIPTS ---
    </script>
</body>
</html>
<script>
// Verificar si hay sesi칩n al cargar el Dashboard
if (!localStorage.getItem("usuario_softcon")) {
    window.location.href = "login.html";
}
// Funci칩n para cargar alertas de sobrecosto en tiempo real
async function cargarAlertasIA() {
    // 1. Obtener datos de comparativa y de historial
    const [resComp, resHist] = await Promise.all([
        fetch(URL_DATABASE + "?pesta침a=COMPARATIVA_ACTUAL"),
        fetch(URL_DATABASE + "?pesta침a=HISTORIAL_PRECIOS")
    ]);

    const comparativas = await resComp.json();
    const historial = await resHist.json();
    
    let htmlAlertas = "";

    // Convertir historial a un objeto para b칰squeda r치pida
    const mapaPrecios = {};
    historial.slice(1).forEach(fila => {
        mapaPrecios[fila[0].toString().toLowerCase()] = fila[1];
    });

    // Analizar las 칰ltimas 5 cotizaciones recibidas
    comparativas.slice(-5).reverse().forEach(cotizacion => {
        const material = cotizacion[3].toString().toLowerCase();
        const precioOfertado = parseFloat(cotizacion[4]);
        const precioAnterior = mapaPrecios[material] || 0;
        const proveedor = cotizacion[2];

        if (precioAnterior > 0 && precioOfertado > precioAnterior) {
            const sobrecosto = (((precioOfertado - precioAnterior) / precioAnterior) * 100).toFixed(1);
            
            htmlAlertas += `
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-xl mb-3 shadow-sm">
                    <div class="flex justify-between items-start">
                        <h4 class="text-[11px] font-black text-red-700 uppercase">丘멆잺 ALERTA DE SOBRECOSTO</h4>
                        <span class="text-[10px] bg-red-200 text-red-800 px-2 py-0.5 rounded-full font-bold">+${sobrecosto}%</span>
                    </div>
                    <p class="text-xs font-bold text-slate-800 mt-1">${cotizacion[3]}</p>
                    <p class="text-[10px] text-slate-600">Proveedor: <b>${proveedor}</b> est치 cobrando Q${precioOfertado} (Antes: Q${precioAnterior})</p>
                    <button onclick="enviarEnlaceWhatsApp('ORDEN_COMPRA', '000', 'ALT')" class="mt-2 text-[9px] font-black text-blue-600 uppercase underline">Cotizar con otro proveedor</button>
                </div>
            `;
        }

            <button onclick="enviarEnlaceWhatsApp('CONTRATO', '502XXXXXXXX', 'NUEVO')" class="w-full mt-4 bg-green-500 text-white font-bold py-2 rounded-xl text-xs uppercase flex items-center justify-center gap-2">
                <i data-lucide="plus-circle"></i> Enviar Nuevo Contrato
            </button>
        </div>

        <div class="bg-white p-6 rounded-[2rem] shadow-lg border-l-8 border-yellow-500">
            <h3 class="font-black text-[#002344] mb-4 flex items-center gap-2">
                <i data-lucide="brain-circuit"></i> INTELIGENCIA DE COMPRAS
            </h3>
            <div id="contenedor-alertas" class="space-y-4">
                <div class="flex items-center justify-center p-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-500"></div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div class="kpi-row">
        <div class="widget bg-azul"><span class="w-title">Ingresos Brutos</span><span class="w-val" id="val1">Q 2.4M</span></div>
        <div class="widget bg-verde"><span class="w-title">Utilidad Real 25%</span><span class="w-val" id="val2">Q 600K</span></div>
        <div class="widget bg-mostaza"><span class="w-title">Avance Cronograma</span><span class="w-val" id="val3">85%</span></div>
        <div class="widget bg-rojo"><span class="w-title">Alertas Cr칤ticas</span><span class="w-val" id="val4">3</span></div>
    </div>

    <div class="main-grid">
        <div class="card">
            <h3 id="line-title">Escala Econ칩mica: Flujo de Caja</h3>
            <canvas id="mainChart" height="140"></canvas>
        </div>
        <div class="card">
            <h3>Distribuci칩n de Gastos</h3>
            <canvas id="pieChart"></canvas>
        </div>
    </div>

    <div class="main-grid">
        <div class="card">
            <h3 id="gantt-title">Gr치fica de Gantt Ejecutiva</h3>
            <div id="ganttContent"></div>
        </div>
        <div class="card">
            <h3>Eficiencia de Mano de Obra</h3>
            <canvas id="barChart"></canvas>
        </div>
    </div>

    <div class="ia-box">
        <div class="ia-header">
            <span>游눠 PANEL DE RECOMENDACIONES ESTRAT칄GICAS</span>
            <span class="reality-tag">ESTADO DE LA REALIDAD</span>
        </div>
        <div class="ia-content">
            <div class="rec-card">
                <h4>츼rea Financiera</h4>
                <p id="rec-fin">Cierre de semana con flujo positivo. Se sugiere reserva para impuestos del pr칩ximo mes.</p>
            </div>
            <div class="rec-card">
                <h4>Log칤stica y Bodega</h4>
                <p id="rec-log">Alerta: Material de fontaner칤a en Proyecto B presenta merma inusual. Revisar entregas.</p>
            </div>
            <div class="rec-card">
                <h4>Operaciones</h4>
                <p id="rec-ope">Proyecto A est치 un 5% por delante del cronograma. Buen rendimiento de cuadrilla 4.</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const rol = localStorage.getItem('userRol');
    const menuGrid = document.querySelector('.nav-grid'); // El contenedor de tus botones

    if (rol === "SUPERVISOR") {
        // Ocultar todo menos Seguimiento y RRHH
        menuGrid.querySelectorAll('.btn-app').forEach(btn => {
            const txt = btn.innerText.toUpperCase();
            if (!txt.includes("SEGUIMIENTO") && !txt.includes("RRHH")) {
                btn.style.display = 'none';
            }
        });
    } else if (rol === "OPERATIVO") {
        // Ocultar todo menos RRHH
        menuGrid.querySelectorAll('.btn-app').forEach(btn => {
            const txt = btn.innerText.toUpperCase();
            if (!txt.includes("RRHH")) {
                btn.style.display = 'none';
            }
        });
    }
});
    // Inicializaci칩n de Gr치ficas (Chart.js)
    const ctxMain = document.getElementById('mainChart').getContext('2d');
    const mainChart = new Chart(ctxMain, {
        type: 'line',
        data: {
            labels: ['S1', 'S2', 'S3', 'S4'],
            datasets: [{ label: 'Ingresos', data: [65, 80, 45, 95], borderColor: '#002344', fill: true, backgroundColor: 'rgba(0,35,68,0.05)', tension: 0.4 },
                       { label: 'Egresos', data: [40, 50, 60, 55], borderColor: '#e1ad01', borderDash: [5,5], tension: 0.4 }]
        }
    });

    const ctxPie = document.getElementById('pieChart').getContext('2d');
    new Chart(ctxPie, {
        type: 'doughnut',
        data: { labels: ['Mat', 'Mano Obra', 'Maq', 'Utilidad'], datasets: [{ data: [40, 30, 5, 25], backgroundColor: ['#002344', '#e1ad01', '#607d8b', '#2e7d32'] }] },
        options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } }
    });

    const ctxBar = document.getElementById('barChart').getContext('2d');
    new Chart(ctxBar, {
        type: 'bar',
        data: { labels: ['P1', 'P2'], datasets: [{ label: 'Rendimiento %', data: [95, 82], backgroundColor: '#002344' }] }
    });

    // L칩gica de Sincronizaci칩n y Filtro
    function syncDashboard(val) {
        const gantt = document.getElementById('ganttContent');
        if(val === 'global') {
            gantt.innerHTML = `
                <div class="gantt-item"><div class="gantt-name">Proyecto A</div><div class="bar-container"><div class="bar-fill" style="width:85%; background:var(--exito)"></div></div></div>
                <div class="gantt-item"><div class="gantt-name">Proyecto B</div><div class="bar-container"><div class="bar-fill" style="width:40%; background:var(--mostaza)"></div></div></div>
            `;
        } else {
            gantt.innerHTML = `
                <div class="gantt-item"><div class="gantt-name">Cimentaci칩n</div><div class="bar-container"><div class="bar-fill" style="width:100%; background:var(--azul)"></div></div></div>
                <div class="gantt-item"><div class="gantt-name">Levantado</div><div class="bar-container"><div class="bar-fill" style="width:65%; background:var(--mostaza)"></div></div></div>
            `;
        }
    }

    // L칩gica de Exportaci칩n Profesional
    function exportReport(type) {
        if(type === 'PDF') {
            alert("SISTEMA SOFTCON-MYS:\nGenerando Informe Ejecutivo en PDF...\nSe incluir치n gr치ficas y cuadro de recomendaciones.");
            window.print(); // Abre el di치logo de impresi칩n configurado profesionalmente
        } else {
            const csvContent = "data:text/csv;charset=utf-8,Proyecto,Ingresos,Egresos,Utilidad\nGlobal,2.4M,1.8M,600K";
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Reporte_SOFTCON_MYS.csv");
            document.body.appendChild(link);
            link.click();
            alert("CSV Exportado exitosamente.");
        }
    }

    syncDashboard('global');
</script>
</script>
</script>
<script>
    // 1. REGISTRO DEL SERVICE WORKER
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker registrado correctamente'))
            .catch(err => console.log('Error al registrar SW', err));
    }

    // 2. L칍GICA DEL BOT칍N DE INSTALACI칍N
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const installBtn = document.getElementById('installBtn');
        if(installBtn) installBtn.classList.remove('hidden');
    });

    document.getElementById('installBtn')?.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                document.getElementById('installBtn').classList.add('hidden');
            }
            deferredPrompt = null;
        }
    });

    // 3. FUNCI칍N DE CERRAR SESI칍N
    function cerrarSesion() {
        localStorage.removeItem("usuario_softcon");
        localStorage.removeItem("rol_softcon");
        localStorage.removeItem("usuario_nombre");
        window.location.href = "login.html";
    }
</script>
</body>
</html>