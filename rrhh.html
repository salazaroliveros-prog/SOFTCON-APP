<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M&S - Control Total RRHH</title>
    <style>
        :root {
            --azul: #002344;
            --mostaza: #e1ad01;
            --mostaza-dark: #b38b00;
            --alerta: #d32f2f;
            --exito: #2e7d32;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; }
        .container { max-width: 1200px; margin: auto; background: white; min-height: 100vh; border: 2px solid var(--azul); }

        header { background: white; padding: 15px; text-align: center; border-bottom: 5px solid var(--mostaza); }
        .nav-tabs { display: flex; background: var(--azul); overflow-x: auto; }
        .tab-btn { flex: 1; padding: 15px; border: none; color: white; background: transparent; cursor: pointer; font-weight: bold; min-width: 120px; }
        .tab-btn.active { background: white; color: var(--azul); }

        .panel { padding: 20px; display: none; }
        .panel.active { display: block; }

        /* Control de Enlaces */
        .link-box { background: #e3f2fd; padding: 20px; border-radius: 10px; display: flex; gap: 10px; align-items: flex-end; margin-bottom: 20px; border: 1px solid #bbdefb; }
        
        /* Mapa Simulado */
        #map-container { width: 100%; height: 400px; background: #e0e0e0; border-radius: 12px; position: relative; overflow: hidden; border: 3px solid var(--azul); }
        .worker-dot { position: absolute; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; cursor: pointer; }
        .dot-ok { background: var(--exito); box-shadow: 0 0 10px var(--exito); }
        .dot-warning { background: var(--alerta); box-shadow: 0 0 10px var(--alerta); animation: pulse 1s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* Tabla de Planilla */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th { background: #f8f9fa; color: var(--azul); padding: 12px; border-bottom: 2px solid var(--mostaza); }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }

        /* Notificaciones y Mensajer√≠a */
        .msg-box { background: var(--azul); color: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        textarea { width: 100%; border-radius: 5px; padding: 10px; margin-top: 10px; }

        .btn-main { background: var(--mostaza); color: var(--azul); border: none; padding: 12px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .btn-danger { background: var(--alerta); color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; }

        /* Estilo App Trabajador */
        .mobile-frame { max-width: 320px; margin: auto; border: 12px solid #333; border-radius: 30px; padding: 20px; background: white; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <img src="https://cdn-icons-png.flaticon.com/512/4333/4333609.png" width="50" alt="logo">
        <h2 style="margin:5px 0;">SOFTCON-MYS-CONSTRU-WM</h2>
        <small style="color:var(--mostaza-dark); font-weight:bold;">"CONSTRUYENDO TU FUTURO"</small>
    </header>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="showTab('jefe')">üëë PANEL DE CONTROL (JEFE)</button>
        <button class="tab-btn" onclick="showTab('mapa-real')">üìç MAPA EN VIVO</button>
        <button class="tab-btn" onclick="showTab('app-personal')">üì≤ APP PERSONAL</button>
    </div>

    <div id="jefe" class="panel active">
        <div class="link-box">
            <div style="flex:2">
                <label>N√∫mero de Tel√©fono (WhatsApp/SMS)</label>
                <input type="tel" id="telTrabajador" placeholder="+502 0000 0000">
            </div>
            <button class="btn-main" onclick="enviarAccion('CONTRATO')">üì© ENVIAR CONTRATO</button>
            <button class="btn-main" style="background:var(--azul); color:white;" onclick="enviarAccion('PLANILLA')">üí∏ ENVIAR PAGO</button>
        </div>

        <h3>Control de Planilla y Mensajer√≠a</h3>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Personal</th>
                    <th>Estado / Tiempo</th>
                    <th>Ubicaci√≥n</th>
                    <th>Sugerencia / Alerta</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>WM-01</td>
                    <td><strong>Mario Estrada</strong><br><small>Alba√±il 1</small></td>
                    <td><span style="color:var(--exito)">Laborando</span></td>
                    <td>Residencial A</td>
                    <td><button class="btn-main" onclick="abrirChat('Mario Estrada')">üí¨ Escribir</button></td>
                </tr>
                <tr style="background:#ffebee;">
                    <td>WM-02</td>
                    <td><strong>Jose Ruano</strong><br><small>Ayudante 1</small></td>
                    <td><span style="color:var(--alerta)">‚ö†Ô∏è EXCESO ALMUERZO (1h 15m)</span></td>
                    <td>Fuera de Rango</td>
                    <td><button class="btn-danger" onclick="abrirChat('Jose Ruano')">üö® ORDENAR REGRESO</button></td>
                </tr>
            </tbody>
        </table>

        <div style="margin-top:20px;">
            <button class="btn-main" style="width:100%; padding:20px; font-size:1.1rem;" onclick="pagoEfectivo()">üí∞ CIERRE DE PLANILLA MANUAL (PAGO EFECTIVO)</button>
        </div>
    </div>

    <div id="mapa-real" class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3>Monitoreo Geocerca en Tiempo Real</h3>
            <div>
                <span class="dot-ok" style="display:inline-block; width:10px; height:10px;"></span> En Obra 
                <span class="dot-warning" style="display:inline-block; width:10px; height:10px; margin-left:10px;"></span> Fuera de L√≠mite
            </div>
        </div>
        <div id="map-container">
            <div class="worker-dot dot-ok" style="top:40%; left:50%;" title="Mario Estrada"></div>
            <div class="worker-dot dot-ok" style="top:42%; left:48%;" title="Alba√±il 2"></div>
            <div class="worker-dot dot-warning" style="top:20%; left:80%;" title="Jose Ruano (Fuera de Rango)"></div>
            <p style="position:absolute; bottom:10px; left:10px; background:white; padding:5px; font-size:0.7rem;">Geocerca: 100m a la redonda de Proyecto Residencial A</p>
        </div>
    </div>

    <div id="app-personal" class="panel">
        <div class="mobile-frame">
            <h3 style="text-align:center; color:var(--azul);">ASISTENCIA M&S</h3>
            <div style="text-align:center; padding:10px; background:#f9f9f9; border-radius:10px;">
                <p>ID: <strong>WM-02</strong></p>
                <p>Status: <span style="color:var(--alerta)">ALMUERZO EXCEDIDO</span></p>
            </div>
            <div style="margin:20px 0; padding:15px; background:#fff3e0; border:1px solid #ffb74d; font-size:0.8rem;">
                <strong>MENSAJE DEL JEFE:</strong><br>
                "Jose, lleva 15 minutos de retraso en su almuerzo. Regrese a la obra inmediatamente o se aplicar√° sanci√≥n monetaria."
            </div>
            <!-- Bot√≥n para marcar asistencia con GPS -->
            <button id="btnCheck" onclick="marcarAsistencia()" style="width:100%; height:100px; border-radius:15px; border:none; background:var(--azul); color:white; font-weight:bold; cursor:pointer;">MARCAR ENTRADA<br>(GPS Habilitado)</button>
            <p style="font-size:0.6rem; color:gray; text-align:center; margin-top:10px;">Al marcar, su ubicaci√≥n ser√° enviada al sistema central y validada por geocerca.</p>
        </div>
        <script>
        // CONFIGURACI√ìN DE LA GEOCERCA (Centro de la Obra)
        const PROYECTO_UBICACION = {
            lat: 14.293, // Ejemplo: Coordenadas de tu obra en Jutiapa
            lng: -89.913,
            radioPermitido: 200 // Metros a la redonda permitidos
        };

        function marcarAsistencia() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(enviarDatosConGPS, errorGPS, {
                    enableHighAccuracy: true // Activa GPS de alta precisi√≥n
                });
            } else {
                alert("Tu navegador no soporta GPS. Contacta a soporte.");
            }
        }

        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const phi1 = lat1 * Math.PI/180;
            const phi2 = lat2 * Math.PI/180;
            const deltaPhi = (lat2-lat1) * Math.PI/180;
            const deltaLambda = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(deltaPhi/2) * Math.sin(deltaPhi/2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(deltaLambda/2) * Math.sin(deltaLambda/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distancia en metros
        }

        function enviarDatosConGPS(posicion) {
            const lat = posicion.coords.latitude;
            const lng = posicion.coords.longitude;
            // Validar Geocerca
            const distancia = calcularDistancia(lat, lng, PROYECTO_UBICACION.lat, PROYECTO_UBICACION.lng);
            const estadoUbicacion = (distancia <= PROYECTO_UBICACION.radioPermitido) ? "DENTRO" : "FUERA";
            const datos = {
                destino: "REGISTRO_ASISTENCIA",
                nombre: localStorage.getItem("usuario_nombre"),
                coordenadas: `${lat},${lng}`,
                distancia: distancia.toFixed(2),
                validacion: estadoUbicacion, // Esto llegar√° a tu Dashboard
                fecha: new Date().toLocaleString()
            };
            // Enviar a Google Apps Script
            fetch(URL_DATABASE, {
                method: 'POST',
                body: JSON.stringify(datos)
            }).then(() => {
                if(estadoUbicacion === "FUERA") {
                    alert("‚ö†Ô∏è MARCADO EXITOSO: Est√°s fuera del per√≠metro de la obra. El administrador ha sido notificado.");
                } else {
                    alert("‚úÖ ASISTENCIA CORRECTA: Est√°s en tu puesto de trabajo.");
                }
            });
        }
        function errorGPS() {
            alert("No se pudo obtener tu ubicaci√≥n. Activa el GPS y vuelve a intentar.");
        }
        </script>
    </div>
</div>

<div id="chatModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:350px; background:white; border:3px solid var(--azul); border-radius:15px; z-index:1000; padding:20px; box-shadow:0 0 50px rgba(0,0,0,0.5);">
    <h4 id="chatName">Mensaje Directo</h4>
    <textarea id="chatInput" rows="4" placeholder="Escriba instrucci√≥n..."></textarea>
    <button class="btn-main" style="width:100%; margin-top:10px;" onclick="enviarMensaje()">ENVIAR NOTIFICACI√ìN PUSH</button>
    <button style="width:100%; background:none; border:none; margin-top:10px; cursor:pointer;" onclick="cerrarChat()">Cerrar</button>
</div>

<script>
    function showTab(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function enviarAccion(tipo) {
        let tel = document.getElementById('telTrabajador').value;
        if(!tel) return alert("Debe ingresar un n√∫mero telef√≥nico.");
        alert(`${tipo} ENVIADO con √©xito al n√∫mero ${tel}. El sistema quedar√° a la espera del registro.`);
    }

    function abrirChat(nombre) {
        document.getElementById('chatModal').style.display = 'block';
        document.getElementById('chatName').innerText = "Instrucci√≥n para: " + nombre;
    }

    function cerrarChat() {
        document.getElementById('chatModal').style.display = 'none';
    }

    function enviarMensaje() {
        alert("Notificaci√≥n PUSH enviada al dispositivo del trabajador. La app vibrar√° y mostrar√° el mensaje en pantalla completa.");
        cerrarChat();
    }

    function asistenciaCheck() {
        if(confirm("Se enviar√°n sus coordenadas GPS. ¬øConfirmar asistencia?")) {
            document.getElementById('btnCheck').innerText = "ASISTENCIA REGISTRADA";
            document.getElementById('btnCheck').style.background = "#ccc";
            document.getElementById('btnCheck').disabled = true;
        }
    }

    function pagoEfectivo() {
        if(confirm("¬øDesea cerrar la planilla actual y procesarla como PAGO EN EFECTIVO? Se generar√° un reporte de egreso manual.")) {
            alert("Planilla procesada. Informaci√≥n enviada al sistema central para ajuste de saldo en caja de obra.");
        }
    }

    // Simulaci√≥n de Alerta Push del Jefe
    setTimeout(() => {
        console.log("Simulando Alerta GPS...");
        // Esta ser√≠a la alerta que le saldr√≠a al jefe en su celular
    }, 5000);
</script>
<div id="btn-back-dashboard" onclick="window.location.href='index.html'" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    background-color: #002344;
    color: #e1ad01;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    z-index: 9999;
    border: 2px solid #e1ad01;
    transition: transform 0.2s;
">
    <span style="font-size: 20px;">üè†</span>
    <span style="font-size: 8px; font-weight: bold;">INICIO</span>
</div>

<script>
    const URL_DATABASE = "https://script.google.com/macros/s/AKfycbxACLXsnOalHL6GE9I0x3JrbXZ8lzrnRBi8RPW-tTjhTPKzFoYzjoGnBQoO0OiSX7L57g/exec";
</script>
</body>
</html>