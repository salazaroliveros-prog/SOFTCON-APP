<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Asistencia GPS</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#002344">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-100 font-sans">
    <main class="max-w-md mx-auto mt-10 p-6 bg-white rounded-2xl shadow-lg">
        <h2 class="text-xl font-black text-[#002344] mb-4">Registro de Asistencia</h2>
        <button type="button" onclick="marcarAsistencia()" class="w-full bg-[#002344] text-white p-4 rounded-2xl font-black flex items-center justify-center gap-2">
            <i data-lucide="map-pin"></i> REGISTRAR ENTRADA CON GPS
        </button>
        <p class="text-xs text-gray-500 mt-2">Tu ubicación será validada por geocerca y enviada al sistema central.</p>
    </main>
    <script>
        // CONFIGURACIÓN DE LA GEOCERCA (Centro de la Obra)
        const PROYECTO_UBICACION = {
            lat: 14.293,
            lng: -89.913,
            radioPermitido: 200
        };
        const URL_DATABASE = "https://script.google.com/macros/s/AKfycbwNpHrYIl_kU_tMLwTOiXiYRcf0pphRKzKh2NIoV2vqqYJ32R9kJUb6RjJtWeAgNkfwyg/exec";
        function marcarAsistencia() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(enviarDatosConGPS, errorGPS, {
                    enableHighAccuracy: true
                });
            } else {
                alert("Tu navegador no soporta GPS. Contacta a soporte.");
            }
        }
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const phi1 = lat1 * Math.PI/180;
            const phi2 = lat2 * Math.PI/180;
            const deltaPhi = (lat2-lat1) * Math.PI/180;
            const deltaLambda = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(deltaPhi/2) * Math.sin(deltaPhi/2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(deltaLambda/2) * Math.sin(deltaLambda/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        function enviarDatosConGPS(posicion) {
            const lat = posicion.coords.latitude;
            const lng = posicion.coords.longitude;
            const distancia = calcularDistancia(lat, lng, PROYECTO_UBICACION.lat, PROYECTO_UBICACION.lng);
            const estadoUbicacion = (distancia <= PROYECTO_UBICACION.radioPermitido) ? "DENTRO" : "FUERA";
            const datos = {
                destino: "REGISTRO_ASISTENCIA",
                nombre: localStorage.getItem("usuario_nombre"),
                coordenadas: `${lat},${lng}`,
                distancia: distancia.toFixed(2),
                validacion: estadoUbicacion,
                fecha: new Date().toLocaleString()
            };
            fetch(URL_DATABASE, {
                method: 'POST',
                body: JSON.stringify(datos)
            }).then(() => {
                if(estadoUbicacion === "FUERA") {
                    alert("⚠️ MARCADO EXITOSO: Estás fuera del perímetro de la obra. El administrador ha sido notificado.");
                } else {
                    alert("✅ ASISTENCIA CORRECTA: Estás en tu puesto de trabajo.");
                }
            });
        }
        function errorGPS() {
            alert("No se pudo obtener tu ubicación. Activa el GPS y vuelve a intentar.");
        }
        lucide.createIcons();
    </script>
    <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
    </script>
</body>
</html>
